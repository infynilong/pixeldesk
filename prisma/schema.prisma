generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(cuid())
  points                   Int                       @default(50)  // 唯一的积分字段，用于所有积分操作
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  avatar                   String?                   // 角色key（如 'hangli'），API层转换为URL
  customAvatar             String?                   // 用户自定义上传的头像URL（优先级高于avatar）
  email                    String?                   @unique
  name                     String
  emailVerified            Boolean                   @default(false)
  isActive                 Boolean                   @default(true)
  lastLogin                DateTime?
  password                 String?
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]
  relatedNotifications     Notification[]            @relation("NotificationRelatedUser")
  notifications            Notification[]
  player                   Player?
  postLikes                PostLike[]
  postReplies              PostReply[]
  posts                    Post[]
  statusHistory            StatusHistory[]
  timeTracking             TimeTracking[]
  onlineStatus             UserOnlineStatus?
  sessions                 UserSession[]
  workstations             UserWorkstation[]
  workSessions             WorkSession[]
  ownedCharacters          CharacterPurchase[]       // 拥有的角色形象
  createdCharacters        Character[]               @relation("CreatedCharacters") // 创建的角色形象

  @@index([email])
  @@index([isActive])
  @@index([lastLogin])
  @@map("users")
}

model StatusHistory {
  id        Int      @id @default(autoincrement())
  userId    String
  emoji     String?
  message   String?
  status    String
  timestamp DateTime @default(now())
  type      String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("status_history")
}

model Workstation {
  id         Int      @id @default(autoincrement())
  name       String
  xPosition  Int
  yPosition  Int
  isOccupied Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("workstations")
}

model UserWorkstation {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId Int
  boundAt       DateTime  @default(now())
  expiresAt     DateTime?
  cost          Int       @default(0)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workstationId])
  @@index([workstationId])
  @@index([boundAt])
  @@index([expiresAt])
  @@index([userId, boundAt])
  @@map("user_workstations")
}

model WorkSession {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId String?
  startTime     DateTime  @default(now())
  endTime       DateTime?
  totalMinutes  Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("work_sessions")
}

model TimeTracking {
  id            Int       @id @default(autoincrement())
  userId        String
  activityType  String
  startTime     DateTime  @default(now())
  endTime       DateTime?
  duration      Int?
  date          DateTime  @default(now())
  workstationId String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, activityType])
  @@map("time_tracking")
}

model Conversation {
  id           String                    @id @default(cuid())
  type         String                    @default("private")
  name         String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime     @default(now())
  isActive       Boolean      @default(true)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  type           String       @default("text")
  status         String       @default("sent")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

model UserOnlineStatus {
  id        String   @id @default(cuid())
  userId    String   @unique
  isOnline  Boolean  @default(false)
  lastSeen  DateTime @default(now())
  socketId  String?
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_online_status")
}

model Post {
  id            String         @id @default(cuid())
  authorId      String
  title         String?
  content       String
  type          PostType       @default(TEXT)
  imageUrl      String?
  isPublic      Boolean        @default(true)
  likeCount     Int            @default(0)
  replyCount    Int            @default(0)
  viewCount     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // 博客相关字段
  summary       String?                      // 摘要（前200字或自定义）
  wordCount     Int            @default(0)  // 字数统计
  readTime      Int            @default(1)  // 预估阅读时间（分钟）
  tags          String[]       @default([]) // 标签
  coverImage    String?                      // 封面图片
  isDraft       Boolean        @default(false) // 是否草稿
  publishedAt   DateTime?                    // 发布时间

  notifications Notification[]
  likes         PostLike[]
  replies       PostReply[]
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([authorId])
  @@index([likeCount])
  @@index([isDraft])
  @@index([publishedAt])
  @@map("posts")
}

model PostReply {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([authorId])
  @@map("post_replies")
}

model PostLike {
  id      String   @id @default(cuid())
  postId  String
  userId  String
  likedAt DateTime @default(now())
  post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("post_likes")
}

model Notification {
  id             String           @id @default(cuid())
  userId         String
  type           NotificationType
  title          String
  message        String
  isRead         Boolean          @default(false)
  relatedPostId  String?
  relatedReplyId String?
  relatedUserId  String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  relatedPost    Post?            @relation(fields: [relatedPostId], references: [id], onDelete: Cascade)
  relatedUser    User?            @relation("NotificationRelatedUser", fields: [relatedUserId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model Player {
  id              String   @id @default(cuid())
  userId          String   @unique
  playerName      String
  characterSprite String   // 当前使用的角色形象名称
  currentX        Int      @default(400)
  currentY        Int      @default(300)
  currentScene    String   @default("Start")
  lastActiveAt    DateTime @default(now())
  playerState     Json?
  totalPlayTime   Int      @default(0) // 总游戏时长（分钟）
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastActiveAt])
  @@index([characterSprite])
  @@index([createdAt])
  @@map("players")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  device    String?
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}

enum PostType {
  TEXT
  IMAGE
  MIXED
  MARKDOWN
}

enum NotificationType {
  POST_REPLY
  POST_LIKE
  SYSTEM
}

// 积分配置表 - 用于管理各种积分奖励和消耗规则
model PointsConfig {
  id          String   @id @default(cuid())
  key         String   @unique  // 配置键，如 'reply_post_reward', 'create_blog_reward', 'bind_workstation_cost'
  value       Int                // 积分数值
  description String             // 配置说明
  category    PointsCategory     // 分类：奖励或消耗
  isActive    Boolean  @default(true)  // 是否启用
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("points_config")
}

enum PointsCategory {
  REWARD    // 积分奖励
  COST      // 积分消耗
}

// ==================== 后台管理系统相关模型 ====================

// 管理员表
model Admin {
  id          String    @id @default(cuid())
  username    String    @unique
  email       String    @unique
  password    String    // bcrypt 加密
  role        AdminRole @default(ADMIN)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?
  isActive    Boolean   @default(true)
  logs        AdminLog[]

  @@index([email])
  @@index([username])
  @@index([isActive])
  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN // 超级管理员，所有权限
  ADMIN       // 普通管理员，大部分权限
  VIEWER      // 只读权限
}

// 管理员操作日志
model AdminLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String   // 'CREATE', 'UPDATE', 'DELETE'
  resource   String   // 'Player', 'Character', 'WorkstationConfig'
  resourceId String?
  details    Json?    // 详细信息
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  admin      Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@index([resource, createdAt])
  @@index([action])
  @@map("admin_logs")
}

// 角色形象表
model Character {
  id              String                @id @default(cuid())
  name            String                @unique // 例如 'hangli', 'Premade_Character_48x48_01'
  displayName     String                // 显示名称，例如 '寒黎', '角色01'
  description     String?               // 描述
  imageUrl        String                // 图片存储路径
  frameWidth      Int                   @default(48)
  frameHeight     Int                   @default(48)
  totalFrames     Int                   @default(8)
  isCompactFormat Boolean               @default(false) // 是否为紧凑格式（2行4列）
  price           Int                   @default(0) // 积分价格，0表示免费
  isDefault       Boolean               @default(false) // 是否为默认角色
  isActive        Boolean               @default(true) // 是否启用
  isUserGenerated Boolean               @default(false) // 是否为用户上传
  creatorId       String?               // 创建者ID（用户上传的角色）
  salesCount      Int                   @default(0) // 销售数量
  sortOrder       Int                   @default(0) // 排序顺序
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // 关联关系
  creator         User?                 @relation("CreatedCharacters", fields: [creatorId], references: [id], onDelete: SetNull)
  purchases       CharacterPurchase[]
  logs            CharacterLog[]

  @@index([isActive, sortOrder])
  @@index([price])
  @@index([createdAt])
  @@index([isDefault])
  @@index([isUserGenerated])
  @@index([creatorId])
  @@map("characters")
}

// 角色形象购买记录（为形象商店准备）
model CharacterPurchase {
  id          String    @id @default(cuid())
  userId      String
  characterId String
  price       Int       // 购买时的价格
  purchasedAt DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([userId, characterId]) // 同一角色只能购买一次
  @@index([userId])
  @@index([characterId])
  @@index([purchasedAt])
  @@map("character_purchases")
}

// 角色形象修改日志
model CharacterLog {
  id          String   @id @default(cuid())
  characterId String
  adminId     String   // 修改者（管理员ID）
  action      String   // 'UPDATE'
  changes     Json     // 修改内容，如 { "price": { "from": 100, "to": 200 } }
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId, createdAt])
  @@index([adminId])
  @@map("character_logs")
}

// 工位配置表
model WorkstationConfig {
  id                 String   @id @default(cuid())
  totalWorkstations  Int      @default(1000) // 总工位数
  bindingCost        Int      @default(10) // 绑定工位消耗积分
  renewalCost        Int      @default(5) // 续期工位消耗积分
  unbindingRefund    Int      @default(5) // 解绑退还积分
  teleportCost       Int      @default(2) // 传送消耗积分
  defaultDuration    Int      @default(24) // 默认绑定时长（小时）
  maxBindingsPerUser Int      @default(1) // 每个用户最多绑定工位数
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  updatedBy          String?  // 更新者ID（管理员）

  @@map("workstation_config")
}
