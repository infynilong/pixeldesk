generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admin_logs {
  id         String   @id
  adminId    String
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  admins     admins   @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([adminId, createdAt])
  @@index([resource, createdAt])
}

model admins {
  id          String       @id
  username    String       @unique
  email       String       @unique
  password    String
  role        AdminRole    @default(ADMIN)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  lastLoginAt DateTime?
  isActive    Boolean      @default(true)
  admin_logs  admin_logs[]

  @@index([email])
  @@index([isActive])
  @@index([username])
}

model ai_chat_history {
  id        String   @id
  userId    String
  npcId     String
  role      String
  content   String
  createdAt DateTime @default(now())

  @@index([userId, npcId, createdAt])
}

model ai_global_config {
  id          String   @id
  provider    String   @default("gemini")
  apiKey      String?
  modelName   String?
  baseUrl     String?
  temperature Float    @default(0.7)
  maxTokens   Int      @default(1000)
  isActive    Boolean  @default(true)
  updatedAt   DateTime
  dailyLimit  Int      @default(20)
}

model ai_npcs {
  id          String   @id
  name        String
  sprite      String
  x           Int
  y           Int
  personality String
  greeting    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  knowledge   String?
  role        String?
  isFixed     Boolean  @default(false)
}

model ai_usage {
  id               String   @id
  userId           String
  count            Int      @default(0)
  date             String
  updatedAt        DateTime
  completionTokens Int      @default(0)
  promptTokens     Int      @default(0)
  totalTokens      Int      @default(0)
  users            users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model character_logs {
  id          String     @id
  characterId String
  adminId     String
  action      String
  changes     Json
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime   @default(now())
  characters  characters @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([characterId, createdAt])
}

model character_purchases {
  id          String     @id
  userId      String
  characterId String
  price       Int
  purchasedAt DateTime   @default(now())
  characters  characters @relation(fields: [characterId], references: [id], onDelete: Cascade)
  users       users      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, characterId])
  @@index([characterId])
  @@index([purchasedAt])
  @@index([userId])
}

model characters {
  id                  String                @id
  name                String                @unique
  displayName         String
  description         String?
  imageUrl            String
  frameWidth          Int                   @default(48)
  frameHeight         Int                   @default(48)
  totalFrames         Int                   @default(8)
  isCompactFormat     Boolean               @default(false)
  price               Int                   @default(0)
  isDefault           Boolean               @default(false)
  isActive            Boolean               @default(true)
  sortOrder           Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  creatorId           String?
  isUserGenerated     Boolean               @default(false)
  salesCount          Int                   @default(0)
  character_logs      character_logs[]
  character_purchases character_purchases[]
  users               users?                @relation(fields: [creatorId], references: [id])

  @@index([createdAt])
  @@index([creatorId])
  @@index([isActive, sortOrder])
  @@index([isDefault])
  @@index([isUserGenerated])
  @@index([price])
}

model conversation_participants {
  id             String        @id
  conversationId String
  userId         String
  joinedAt       DateTime      @default(now())
  lastReadAt     DateTime      @default(now())
  isActive       Boolean       @default(true)
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  users          users         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model conversations {
  id                        String                      @id
  type                      String                      @default("private")
  name                      String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  conversation_participants conversation_participants[]
  messages                  messages[]
}

model library_books {
  id          String   @id
  title       String
  author      String
  description String?
  coverUrl    String?
  content     String?
  bookcaseId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([bookcaseId])
}

model messages {
  id             String        @id
  conversationId String
  senderId       String
  content        String
  type           String        @default("text")
  status         String        @default("sent")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  users          users         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model notifications {
  id                                       String           @id
  userId                                   String
  type                                     NotificationType
  title                                    String
  message                                  String
  isRead                                   Boolean          @default(false)
  relatedPostId                            String?
  relatedReplyId                           String?
  relatedUserId                            String?
  createdAt                                DateTime         @default(now())
  updatedAt                                DateTime
  posts                                    posts?           @relation(fields: [relatedPostId], references: [id], onDelete: Cascade)
  users_notifications_relatedUserIdTousers users?           @relation("notifications_relatedUserIdTousers", fields: [relatedUserId], references: [id], onDelete: Cascade)
  users_notifications_userIdTousers        users            @relation("notifications_userIdTousers", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, isRead])
}

model players {
  id              String   @id
  userId          String   @unique
  playerName      String
  characterSprite String
  currentX        Int      @default(400)
  currentY        Int      @default(300)
  currentScene    String   @default("Start")
  lastActiveAt    DateTime @default(now())
  playerState     Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  totalPlayTime   Int      @default(0)
  users           users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([characterSprite])
  @@index([createdAt])
  @@index([lastActiveAt])
  @@index([userId])
}

model points_config {
  id          String         @id
  key         String         @unique
  value       Int
  description String
  category    PointsCategory
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime

  @@index([category])
  @@index([key])
}

model points_history {
  id        String   @id
  userId    String
  amount    Int
  reason    String
  type      String
  balance   Int
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model post_likes {
  id      String   @id
  postId  String
  userId  String
  likedAt DateTime @default(now())
  posts   posts    @relation(fields: [postId], references: [id], onDelete: Cascade)
  users   users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model post_replies {
  id        String   @id
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([postId, createdAt])
}

model posts {
  id              String          @id
  authorId        String
  title           String?
  content         String
  type            PostType        @default(TEXT)
  imageUrl        String?
  isPublic        Boolean         @default(true)
  likeCount       Int             @default(0)
  replyCount      Int             @default(0)
  viewCount       Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  coverImage      String?
  isDraft         Boolean         @default(false)
  publishedAt     DateTime?
  readTime        Int             @default(1)
  summary         String?
  tags            String[]        @default([])
  wordCount       Int             @default(0)
  imageUrls       String[]        @default([])
  moderationStatus String         @default("pending")  // pending, approved, rejected, flagged
  isActive        Boolean         @default(true)       // 是否启用（禁用后不显示）
  aiReviewResult  String?                              // AI审查结果
  aiReviewedAt    DateTime?                            // AI审查时间
  reviewedBy      String?                              // 审查人ID
  reviewedAt      DateTime?                            // 人工审查时间
  reviewNotes     String?                              // 审查备注
  notifications   notifications[]
  post_likes      post_likes[]
  post_replies    post_replies[]
  users           users           @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([isDraft])
  @@index([likeCount])
  @@index([publishedAt])
  @@index([moderationStatus])
  @@index([isActive])
}

model status_history {
  id        Int      @id @default(autoincrement())
  userId    String
  emoji     String?
  message   String?
  status    String
  timestamp DateTime @default(now())
  type      String
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model system_config {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  updatedAt   DateTime
}

model time_tracking {
  id            Int       @id @default(autoincrement())
  userId        String
  activityType  String
  startTime     DateTime  @default(now())
  endTime       DateTime?
  duration      Int?
  date          DateTime  @default(now())
  workstationId String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  users         users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, activityType])
  @@index([userId, date])
}

model user_online_status {
  id        String   @id
  userId    String   @unique
  isOnline  Boolean  @default(false)
  lastSeen  DateTime @default(now())
  socketId  String?
  updatedAt DateTime
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model user_sessions {
  id        String   @id
  userId    String
  token     String   @unique
  device    String?
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model user_workstations {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId Int
  boundAt       DateTime  @default(now())
  cost          Int       @default(0)
  expiresAt     DateTime?
  users         users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workstationId])
  @@index([boundAt])
  @@index([expiresAt])
  @@index([userId, boundAt])
  @@index([workstationId])
}

model users {
  id                                               String                      @id
  points                                           Int                         @default(100)
  createdAt                                        DateTime                    @default(now())
  updatedAt                                        DateTime
  avatar                                           String?
  email                                            String?                     @unique
  name                                             String
  emailVerified                                    Boolean                     @default(false)
  isActive                                         Boolean                     @default(true)
  lastLogin                                        DateTime?
  password                                         String?
  customAvatar                                     String?
  ai_usage                                         ai_usage[]
  character_purchases                              character_purchases[]
  characters                                       characters[]
  conversation_participants                        conversation_participants[]
  messages                                         messages[]
  notifications_notifications_relatedUserIdTousers notifications[]             @relation("notifications_relatedUserIdTousers")
  notifications_notifications_userIdTousers        notifications[]             @relation("notifications_userIdTousers")
  players                                          players?
  points_history                                   points_history[]
  post_likes                                       post_likes[]
  post_replies                                     post_replies[]
  posts                                            posts[]
  status_history                                   status_history[]
  time_tracking                                    time_tracking[]
  user_online_status                               user_online_status?
  user_sessions                                    user_sessions[]
  user_workstations                                user_workstations[]
  work_sessions                                    work_sessions[]

  @@index([email])
  @@index([isActive])
  @@index([lastLogin])
}

model work_sessions {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId String?
  startTime     DateTime  @default(now())
  endTime       DateTime?
  totalMinutes  Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  users         users     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model workstation_config {
  id                 String   @id
  totalWorkstations  Int      @default(1000)
  bindingCost        Int      @default(10)
  renewalCost        Int      @default(5)
  unbindingRefund    Int      @default(5)
  teleportCost       Int      @default(2)
  defaultDuration    Int      @default(24)
  maxBindingsPerUser Int      @default(1)
  createdAt          DateTime @default(now())
  updatedAt          DateTime
  updatedBy          String?
}

model workstations {
  id         Int      @id @default(autoincrement())
  name       String
  xPosition  Int
  yPosition  Int
  isOccupied Boolean  @default(false)
  createdAt  DateTime @default(now())
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

enum NotificationType {
  POST_REPLY
  POST_LIKE
  SYSTEM
}

enum PointsCategory {
  REWARD
  COST
}

enum PostType {
  TEXT
  IMAGE
  MIXED
  MARKDOWN
}
