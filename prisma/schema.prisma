generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(cuid())
  points                   Int                       @default(50)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  avatar                   String?
  email                    String?                   @unique
  gold                     Int                       @default(50)
  name                     String
  emailVerified            Boolean                   @default(false)
  isActive                 Boolean                   @default(true)
  lastLogin                DateTime?
  password                 String?
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]
  relatedNotifications     Notification[]            @relation("NotificationRelatedUser")
  notifications            Notification[]
  player                   Player?
  postLikes                PostLike[]
  postReplies              PostReply[]
  posts                    Post[]
  statusHistory            StatusHistory[]
  timeTracking             TimeTracking[]
  onlineStatus             UserOnlineStatus?
  sessions                 UserSession[]
  workstations             UserWorkstation[]
  workSessions             WorkSession[]

  @@index([email])
  @@index([isActive])
  @@map("users")
}

model StatusHistory {
  id        Int      @id @default(autoincrement())
  userId    String
  emoji     String?
  message   String?
  status    String
  timestamp DateTime @default(now())
  type      String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("status_history")
}

model Workstation {
  id         Int      @id @default(autoincrement())
  name       String
  xPosition  Int
  yPosition  Int
  isOccupied Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("workstations")
}

model UserWorkstation {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId Int
  boundAt       DateTime  @default(now())
  expiresAt     DateTime?
  cost          Int       @default(0)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workstationId])
  @@index([workstationId])
  @@index([boundAt])
  @@index([expiresAt])
  @@index([userId, boundAt])
  @@map("user_workstations")
}

model WorkSession {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId String?
  startTime     DateTime  @default(now())
  endTime       DateTime?
  totalMinutes  Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("work_sessions")
}

model TimeTracking {
  id            Int       @id @default(autoincrement())
  userId        String
  activityType  String
  startTime     DateTime  @default(now())
  endTime       DateTime?
  duration      Int?
  date          DateTime  @default(now())
  workstationId String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, activityType])
  @@map("time_tracking")
}

model Conversation {
  id           String                    @id @default(cuid())
  type         String                    @default("private")
  name         String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime     @default(now())
  isActive       Boolean      @default(true)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  type           String       @default("text")
  status         String       @default("sent")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

model UserOnlineStatus {
  id        String   @id @default(cuid())
  userId    String   @unique
  isOnline  Boolean  @default(false)
  lastSeen  DateTime @default(now())
  socketId  String?
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_online_status")
}

model Post {
  id            String         @id @default(cuid())
  authorId      String
  title         String?
  content       String
  type          PostType       @default(TEXT)
  imageUrl      String?
  isPublic      Boolean        @default(true)
  likeCount     Int            @default(0)
  replyCount    Int            @default(0)
  viewCount     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // 博客相关字段
  summary       String?                      // 摘要（前200字或自定义）
  wordCount     Int            @default(0)  // 字数统计
  readTime      Int            @default(1)  // 预估阅读时间（分钟）
  tags          String[]       @default([]) // 标签
  coverImage    String?                      // 封面图片
  isDraft       Boolean        @default(false) // 是否草稿
  publishedAt   DateTime?                    // 发布时间

  notifications Notification[]
  likes         PostLike[]
  replies       PostReply[]
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([authorId])
  @@index([likeCount])
  @@index([isDraft])
  @@index([publishedAt])
  @@map("posts")
}

model PostReply {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([authorId])
  @@map("post_replies")
}

model PostLike {
  id      String   @id @default(cuid())
  postId  String
  userId  String
  likedAt DateTime @default(now())
  post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("post_likes")
}

model Notification {
  id             String           @id @default(cuid())
  userId         String
  type           NotificationType
  title          String
  message        String
  isRead         Boolean          @default(false)
  relatedPostId  String?
  relatedReplyId String?
  relatedUserId  String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  relatedPost    Post?            @relation(fields: [relatedPostId], references: [id], onDelete: Cascade)
  relatedUser    User?            @relation("NotificationRelatedUser", fields: [relatedUserId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model Player {
  id              String   @id @default(cuid())
  userId          String   @unique
  playerName      String
  characterSprite String
  gamePoints      Int      @default(50)
  gameGold        Int      @default(50)
  currentX        Int      @default(400)
  currentY        Int      @default(300)
  currentScene    String   @default("Start")
  lastActiveAt    DateTime @default(now())
  playerState     Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastActiveAt])
  @@map("players")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  device    String?
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}

enum PostType {
  TEXT
  IMAGE
  MIXED
  MARKDOWN
}

enum NotificationType {
  POST_REPLY
  POST_LIKE
  SYSTEM
}

// 积分配置表 - 用于管理各种积分奖励和消耗规则
model PointsConfig {
  id          String   @id @default(cuid())
  key         String   @unique  // 配置键，如 'reply_post_reward', 'create_blog_reward', 'bind_workstation_cost'
  value       Int                // 积分数值
  description String             // 配置说明
  category    PointsCategory     // 分类：奖励或消耗
  isActive    Boolean  @default(true)  // 是否启用
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("points_config")
}

enum PointsCategory {
  REWARD    // 积分奖励
  COST      // 积分消耗
}
