generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(cuid())
  points                   Int                       @default(100)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  avatar                   String?
  email                    String?                   @unique
  name                     String
  emailVerified            Boolean                   @default(false)
  isActive                 Boolean                   @default(true)
  lastLogin                DateTime?
  password                 String?
  customAvatar             String?
  aiUsages                 AiUsage[]
  ownedCharacters          CharacterPurchase[]
  createdCharacters        Character[]               @relation("CreatedCharacters")
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]
  relatedNotifications     Notification[]            @relation("NotificationRelatedUser")
  notifications            Notification[]
  player                   Player?
  pointsHistory            PointsHistory[]
  postLikes                PostLike[]
  postReplies              PostReply[]
  posts                    Post[]
  statusHistory            StatusHistory[]
  timeTracking             TimeTracking[]
  onlineStatus             UserOnlineStatus?
  sessions                 UserSession[]
  workstations             UserWorkstation[]
  workSessions             WorkSession[]

  @@index([email])
  @@index([isActive])
  @@index([lastLogin])
  @@map("users")
}

model StatusHistory {
  id        Int      @id @default(autoincrement())
  userId    String
  emoji     String?
  message   String?
  status    String
  timestamp DateTime @default(now())
  type      String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("status_history")
}

model Workstation {
  id         Int      @id @default(autoincrement())
  name       String
  xPosition  Int
  yPosition  Int
  isOccupied Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("workstations")
}

model UserWorkstation {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId Int
  boundAt       DateTime  @default(now())
  cost          Int       @default(0)
  expiresAt     DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workstationId])
  @@index([workstationId])
  @@index([boundAt])
  @@index([expiresAt])
  @@index([userId, boundAt])
  @@map("user_workstations")
}

model WorkSession {
  id            Int       @id @default(autoincrement())
  userId        String
  workstationId String?
  startTime     DateTime  @default(now())
  endTime       DateTime?
  totalMinutes  Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("work_sessions")
}

model TimeTracking {
  id            Int       @id @default(autoincrement())
  userId        String
  activityType  String
  startTime     DateTime  @default(now())
  endTime       DateTime?
  duration      Int?
  date          DateTime  @default(now())
  workstationId String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, activityType])
  @@map("time_tracking")
}

model Conversation {
  id           String                    @id @default(cuid())
  type         String                    @default("private")
  name         String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime     @default(now())
  isActive       Boolean      @default(true)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  type           String       @default("text")
  status         String       @default("sent")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

model UserOnlineStatus {
  id        String   @id @default(cuid())
  userId    String   @unique
  isOnline  Boolean  @default(false)
  lastSeen  DateTime @default(now())
  socketId  String?
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_online_status")
}

model Post {
  id            String         @id @default(cuid())
  authorId      String
  title         String?
  content       String
  type          PostType       @default(TEXT)
  imageUrl      String?
  isPublic      Boolean        @default(true)
  likeCount     Int            @default(0)
  replyCount    Int            @default(0)
  viewCount     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  coverImage    String?
  isDraft       Boolean        @default(false)
  publishedAt   DateTime?
  readTime      Int            @default(1)
  summary       String?
  tags          String[]       @default([])
  wordCount     Int            @default(0)
  notifications Notification[]
  likes         PostLike[]
  replies       PostReply[]
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([authorId])
  @@index([likeCount])
  @@index([isDraft])
  @@index([publishedAt])
  @@map("posts")
}

model PostReply {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([authorId])
  @@map("post_replies")
}

model PostLike {
  id      String   @id @default(cuid())
  postId  String
  userId  String
  likedAt DateTime @default(now())
  post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("post_likes")
}

model Notification {
  id             String           @id @default(cuid())
  userId         String
  type           NotificationType
  title          String
  message        String
  isRead         Boolean          @default(false)
  relatedPostId  String?
  relatedReplyId String?
  relatedUserId  String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  relatedPost    Post?            @relation(fields: [relatedPostId], references: [id], onDelete: Cascade)
  relatedUser    User?            @relation("NotificationRelatedUser", fields: [relatedUserId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model Player {
  id              String   @id @default(cuid())
  userId          String   @unique
  playerName      String
  characterSprite String
  currentX        Int      @default(400)
  currentY        Int      @default(300)
  currentScene    String   @default("Start")
  lastActiveAt    DateTime @default(now())
  playerState     Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  totalPlayTime   Int      @default(0)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastActiveAt])
  @@index([characterSprite])
  @@index([createdAt])
  @@map("players")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  device    String?
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}

model PointsConfig {
  id          String         @id @default(cuid())
  key         String         @unique
  value       Int
  description String
  category    PointsCategory
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([key])
  @@index([category])
  @@map("points_config")
}

model Admin {
  id          String     @id @default(cuid())
  username    String     @unique
  email       String     @unique
  password    String
  role        AdminRole  @default(ADMIN)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  lastLoginAt DateTime?
  isActive    Boolean    @default(true)
  logs        AdminLog[]

  @@index([email])
  @@index([username])
  @@index([isActive])
  @@map("admins")
}

model AdminLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  admin      Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@index([resource, createdAt])
  @@index([action])
  @@map("admin_logs")
}

model Character {
  id              String              @id @default(cuid())
  name            String              @unique
  displayName     String
  description     String?
  imageUrl        String
  frameWidth      Int                 @default(48)
  frameHeight     Int                 @default(48)
  totalFrames     Int                 @default(8)
  isCompactFormat Boolean             @default(false)
  price           Int                 @default(0)
  isDefault       Boolean             @default(false)
  isActive        Boolean             @default(true)
  sortOrder       Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  creatorId       String?
  isUserGenerated Boolean             @default(false)
  salesCount      Int                 @default(0)
  logs            CharacterLog[]
  purchases       CharacterPurchase[]
  creator         User?               @relation("CreatedCharacters", fields: [creatorId], references: [id])

  @@index([isActive, sortOrder])
  @@index([price])
  @@index([createdAt])
  @@index([isDefault])
  @@index([isUserGenerated])
  @@index([creatorId])
  @@map("characters")
}

model CharacterPurchase {
  id          String    @id @default(cuid())
  userId      String
  characterId String
  price       Int
  purchasedAt DateTime  @default(now())
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, characterId])
  @@index([userId])
  @@index([characterId])
  @@index([purchasedAt])
  @@map("character_purchases")
}

model CharacterLog {
  id          String    @id @default(cuid())
  characterId String
  adminId     String
  action      String
  changes     Json
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId, createdAt])
  @@index([adminId])
  @@map("character_logs")
}

model WorkstationConfig {
  id                 String   @id @default(cuid())
  totalWorkstations  Int      @default(1000)
  bindingCost        Int      @default(10)
  renewalCost        Int      @default(5)
  unbindingRefund    Int      @default(5)
  teleportCost       Int      @default(2)
  defaultDuration    Int      @default(24)
  maxBindingsPerUser Int      @default(1)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  updatedBy          String?

  @@map("workstation_config")
}

model PointsHistory {
  id        String   @id @default(cuid())
  userId    String
  amount    Int
  reason    String
  type      String
  balance   Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("points_history")
}

model AiNpc {
  id          String   @id @default(cuid())
  name        String
  sprite      String
  x           Int
  y           Int
  personality String
  greeting    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  knowledge   String?
  role        String?
  isFixed     Boolean  @default(false)

  @@map("ai_npcs")
}

model AiGlobalConfig {
  id          String   @id @default(cuid())
  provider    String   @default("gemini")
  apiKey      String?
  modelName   String?
  baseUrl     String?
  temperature Float    @default(0.7)
  maxTokens   Int      @default(1000)
  isActive    Boolean  @default(true)
  updatedAt   DateTime @updatedAt
  dailyLimit  Int      @default(20)

  @@map("ai_global_config")
}

model AiUsage {
  id               String   @id @default(cuid())
  userId           String
  count            Int      @default(0)
  date             String
  updatedAt        DateTime @updatedAt
  completionTokens Int      @default(0)
  promptTokens     Int      @default(0)
  totalTokens      Int      @default(0)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("ai_usage")
}

model AiChatHistory {
  id        String   @id @default(cuid())
  userId    String
  npcId     String
  role      String
  content   String
  createdAt DateTime @default(now())

  @@index([userId, npcId, createdAt])
  @@map("ai_chat_history")
}

enum PostType {
  TEXT
  IMAGE
  MIXED
  MARKDOWN
}

enum NotificationType {
  POST_REPLY
  POST_LIKE
  SYSTEM
}

enum PointsCategory {
  REWARD
  COST
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}
