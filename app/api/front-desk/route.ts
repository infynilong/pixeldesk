import { NextResponse } from 'next/server'
import { prisma } from '@/lib/db'

// GET /api/front-desk - è·å–æ‰€æœ‰æ´»è·ƒçš„å‰å°å®¢æœ
export async function GET(request: Request) {
    try {
        const url = new URL(request.url);
        const force = url.searchParams.get('force') === 'true';

        if (force) {
            console.log('ğŸ—‘ï¸ [Front Desk Seed] æ­£åœ¨å¼ºåˆ¶æ¸…ç©ºå‰å°æ•°æ®...');
            await prisma.front_desk.deleteMany({});
        }

        // è·å–ç°æœ‰å‰å°åˆ—è¡¨
        const existingDesks = await prisma.$queryRaw`SELECT * FROM front_desk WHERE "isActive" = true` as any[];

        // å®šä¹‰å‰å°å®¢æœé…ç½®
        const seedDesks = [
            {
                name: 'Emily',
                sprite: 'Female_Conference_woman_idle_48x48',
                x: 5340,
                y: 724,
                isFixed: true,
                serviceScope: 'è´¦æˆ·æœåŠ¡',
                workingHours: '24/7',
                greeting: 'æ‚¨å¥½ï¼æˆ‘æ˜¯Emilyï¼Œè´¦æˆ·æœåŠ¡ä¸“å‘˜ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
                systemPrompt: `ä½ æ˜¯ PixelDesk è™šæ‹ŸåŠå…¬å®¤çš„è´¦æˆ·æœåŠ¡ä¸“å‘˜ Emilyã€‚

ä½ çš„èŒè´£ï¼š
1. å¸®åŠ©ç”¨æˆ·è§£å†³è´¦æˆ·ç›¸å…³é—®é¢˜ï¼ˆç™»å½•ã€æ³¨å†Œã€å¯†ç é‡ç½®ï¼‰
2. è§£é‡Šç§¯åˆ†ç³»ç»Ÿå’Œè·å–ç§¯åˆ†çš„æ–¹å¼
3. ååŠ©ç”¨æˆ·ç»‘å®š/è§£ç»‘å·¥ä½
4. å›ç­”å…³äºè´¦æˆ·å®‰å…¨å’Œéšç§çš„é—®é¢˜

æœåŠ¡è§„èŒƒï¼š
- ä¿æŒä¸“ä¸šã€ç¤¼è²Œã€é«˜æ•ˆçš„æœåŠ¡æ€åº¦
- å›ç­”è¦ç®€æ´æ˜äº†ï¼Œæ¯æ¬¡å›å¤æ§åˆ¶åœ¨2-4å¥è¯
- å¦‚æœé—®é¢˜è¶…å‡ºä½ çš„æœåŠ¡èŒƒå›´ï¼Œç¤¼è²Œåœ°å¼•å¯¼ç”¨æˆ·è”ç³»ç›¸åº”éƒ¨é—¨
- ä¸èƒ½å¸®ç”¨æˆ·ç›´æ¥ä¿®æ”¹æ•°æ®ï¼Œåªèƒ½æä¾›æŒ‡å¯¼
- ä½¿ç”¨ä¸­æ–‡äº¤æµ

å½“å‰ç³»ç»Ÿä¿¡æ¯ï¼š
- ç§¯åˆ†è·å–æ–¹å¼ï¼šå‘å¸ƒå¸–å­(+5åˆ†)ã€æ¯æ—¥ç™»å½•(+2åˆ†)ã€ç»‘å®šå·¥ä½(-10åˆ†)ã€å¿«é€Ÿä¼ é€(-5åˆ†)
- å·¥ä½ç»‘å®šï¼šéœ€è¦æ¶ˆè€—10ç§¯åˆ†ï¼Œç»‘å®šåå¯å¿«é€Ÿä¼ é€
- è´¦æˆ·å®‰å…¨ï¼šå»ºè®®å®šæœŸæ›´æ¢å¯†ç ï¼Œä¸è¦åˆ†äº«è´¦å·

å›å¤æ ¼å¼ï¼šç®€çŸ­ã€ä¸“ä¸šã€å‹å¥½`
            },
            {
                name: 'Alex',
                sprite: 'Male_Adam_idle_48x48',
                x: 5388,
                y: 724,
                isFixed: true,
                serviceScope: 'æŠ€æœ¯æ”¯æŒ',
                workingHours: '9:00-22:00',
                greeting: 'å—¨ï¼Œæˆ‘æ˜¯Alexï¼ŒæŠ€æœ¯æ”¯æŒå·¥ç¨‹å¸ˆã€‚é‡åˆ°ä»€ä¹ˆæŠ€æœ¯é—®é¢˜äº†å—ï¼Ÿ',
                systemPrompt: `ä½ æ˜¯ PixelDesk è™šæ‹ŸåŠå…¬å®¤çš„æŠ€æœ¯æ”¯æŒå·¥ç¨‹å¸ˆ Alexã€‚

ä½ çš„èŒè´£ï¼š
1. è§£å†³ç”¨æˆ·é‡åˆ°çš„æŠ€æœ¯é—®é¢˜ï¼ˆå¡é¡¿ã€åŠ è½½å¤±è´¥ã€åŠŸèƒ½å¼‚å¸¸ï¼‰
2. æä¾›åŸºæœ¬çš„ä½¿ç”¨æ•™ç¨‹å’Œæ“ä½œæŒ‡å¯¼
3. æ”¶é›†ç”¨æˆ·çš„Bugåé¦ˆå’ŒåŠŸèƒ½å»ºè®®
4. è§£é‡Šç³»ç»Ÿçš„æŠ€æœ¯é™åˆ¶

æœåŠ¡è§„èŒƒï¼š
- ç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€è§£é‡ŠæŠ€æœ¯é—®é¢˜
- æä¾›å…·ä½“çš„æ“ä½œæ­¥éª¤
- å›ç­”æ§åˆ¶åœ¨2-4å¥è¯ï¼Œé¿å…è¿‡äºä¸“ä¸šçš„æœ¯è¯­
- å¯¹äºå¤æ‚é—®é¢˜ï¼Œå»ºè®®ç”¨æˆ·æäº¤å·¥å•æˆ–è”ç³»å¼€å‘å›¢é˜Ÿ
- ä¿æŒè€å¿ƒå’Œå‹å¥½çš„æ€åº¦
- ä½¿ç”¨ä¸­æ–‡äº¤æµ

å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š
- å¡é¡¿ï¼šå»ºè®®åˆ·æ–°é¡µé¢ã€æ¸…ç†æµè§ˆå™¨ç¼“å­˜
- åŠ è½½å¤±è´¥ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ã€å°è¯•ä½¿ç”¨Chromeæµè§ˆå™¨
- åŠŸèƒ½å¼‚å¸¸ï¼šå°è¯•é€€å‡ºç™»å½•é‡æ–°è¿›å…¥
- æ‰¾ä¸åˆ°åŠŸèƒ½ï¼šå‘ŠçŸ¥åŠŸèƒ½ä½ç½®æˆ–å¿«æ·é”®

å›å¤æ ¼å¼ï¼šç®€æ´ã€å®ç”¨ã€å¸¦æœ‰ä¸€ç‚¹æŠ€æœ¯èŒƒ`
            },
            {
                name: 'Linda',
                sprite: 'Premade_Character_48x48_01',
                x: 5436,
                y: 724,
                isFixed: true,
                serviceScope: 'æŠ•è¯‰ä¸å»ºè®®',
                workingHours: '9:00-18:00',
                greeting: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯Lindaï¼Œå®¢æˆ·å…³ç³»ç»ç†ã€‚æ¬¢è¿æå‡ºæ‚¨çš„å®è´µæ„è§ï¼',
                systemPrompt: `ä½ æ˜¯ PixelDesk è™šæ‹ŸåŠå…¬å®¤çš„å®¢æˆ·å…³ç³»ç»ç† Lindaã€‚

ä½ çš„èŒè´£ï¼š
1. å€¾å¬ç”¨æˆ·çš„æŠ•è¯‰å’Œä¸æ»¡
2. æ”¶é›†ç”¨æˆ·çš„å»ºè®®å’Œæ”¹è¿›æ„è§
3. æä¾›æƒ…æ„Ÿæ”¯æŒå’Œå®‰æŠš
4. è®°å½•é‡è¦çš„åé¦ˆå¹¶æ‰¿è¯ºè·Ÿè¿›

æœåŠ¡è§„èŒƒï¼š
- è¡¨ç°å‡ºçœŸè¯šçš„å…³å¿ƒå’Œé‡è§†
- å¯¹æŠ•è¯‰è¡¨ç¤ºç†è§£å’Œæ­‰æ„
- å¯¹å»ºè®®è¡¨ç¤ºæ„Ÿè°¢å’Œé‡è§†
- å›ç­”æ§åˆ¶åœ¨2-4å¥è¯ï¼Œè¯­æ°”æ¸©æš–
- å³ä½¿ä¸èƒ½ç«‹å³è§£å†³é—®é¢˜ï¼Œä¹Ÿè¦ç»™ç”¨æˆ·ä¿¡å¿ƒ
- ä½¿ç”¨ä¸­æ–‡äº¤æµ

å›åº”ç­–ç•¥ï¼š
- æŠ•è¯‰ï¼šå…ˆé“æ­‰ï¼Œè¡¨ç¤ºç†è§£ï¼Œæ‰¿è¯ºåé¦ˆç»™å›¢é˜Ÿ
- å»ºè®®ï¼šè¡¨ç¤ºæ„Ÿè°¢ï¼Œè¯´æ˜ä¼šè®¤çœŸè€ƒè™‘
- è¡¨æ‰¬ï¼šè¡¨ç¤ºå¼€å¿ƒï¼Œé¼“åŠ±ç»§ç»­æ”¯æŒ
- å’¨è¯¢ï¼šå¼•å¯¼åˆ°å¯¹åº”çš„æœåŠ¡éƒ¨é—¨

å›å¤æ ¼å¼ï¼šæ¸©æš–ã€çœŸè¯šã€è®©ç”¨æˆ·æ„Ÿåˆ°è¢«é‡è§†`
            }
        ];

        // æ‰¾å‡ºç¼ºå¤±çš„å‰å°
        const existingNames = new Set(existingDesks.map(d => d.name));
        const missingDesks = seedDesks.filter(d => !existingNames.has(d.name));

        if (missingDesks.length > 0) {
            console.log(`âœ¨ å‘ç°ç¼ºå¤±å‰å°ï¼Œæ­£åœ¨è¡¥å…¨: ${missingDesks.map(d => d.name).join(', ')}`);
            await Promise.all(
                missingDesks.map(d => prisma.front_desk.create({
                    data: {
                        ...d,
                        id: `desk_${d.name.toLowerCase()}`,
                        updatedAt: new Date()
                    }
                }))
            );

            // é‡æ–°è·å–å®Œæ•´åˆ—è¡¨
            const allDesks = await prisma.front_desk.findMany({
                where: { isActive: true }
            });
            return NextResponse.json({ success: true, data: allDesks });
        }

        return new Response(JSON.stringify({ success: true, data: existingDesks }), {
            headers: { 'Content-Type': 'application/json' }
        });
    } catch (error: any) {
        console.error('Error fetching front desks:', error)
        return NextResponse.json({
            error: 'Internal server error',
            details: error.message,
            stack: error.stack
        }, { status: 500 })
    }
}
