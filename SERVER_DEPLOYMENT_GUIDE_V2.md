# PixelDesk æœåŠ¡å™¨éƒ¨ç½²æŒ‡å— (2026.01 æ›´æ–°)

æœ¬æ–‡æ¡£æ•´ç†äº†åœ¨å¯¹ **Prisma Workstation ID** è¿›è¡Œæ¶æ„è°ƒæ•´åŠæ‰§è¡Œå¤§æ‰¹é‡æ•°æ®è¿ç§»è„šæœ¬åçš„æœåŠ¡å™¨éƒ¨ç½²æµç¨‹ã€‚

## âš ï¸ éƒ¨ç½²å‰å¿…é¡»æ‰§è¡Œï¼šæ•°æ®åº“å¤‡ä»½

åœ¨è¿›è¡Œä»»ä½•ç ´åæ€§æ“ä½œï¼ˆå¦‚æ¶æ„ä¿®æ”¹æˆ–æ•°æ®è¿ç§»ï¼‰å‰ï¼Œè¯·åŠ¡å¿…å¤‡ä»½ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ã€‚

```bash
# å‡è®¾ä½¿ç”¨ Docker éƒ¨ç½²
docker exec -t [DB_CONTAINER_NAME] pg_dump -U pixel_user pixeldesk > pixeldesk_backup_$(date +%Y%m%d).sql

# å¦‚æœæ˜¯è£¸æœºéƒ¨ç½²
pg_dump -U pixel_user pixeldesk > pixeldesk_backup_$(date +%Y%m%d).sql
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. æ›´æ–°ä»£ç 
åŒæ­¥æœ€æ–°çš„ä»£ç åŠåœ°å›¾èµ„æºã€‚

```bash
git pull origin main
```

### 2. æ›´æ–°åœ°å›¾ Stable ID (å¦‚æœ‰å¿…è¦)
ç¡®ä¿ `public/assets/officemap.json` å·²ç»åŒ…å«äº†æœ€æ–°çš„ `ws_id` (UUID)ã€‚

```bash
# åœ¨å®¿ä¸»æœºè¿è¡Œï¼ˆå› ä¸ºæ¶‰åŠæ–‡ä»¶åŒæ­¥åˆ° git/å®¹å™¨å·ï¼‰
npm run update-map-ids
```

### 3. æ‰§è¡Œ Prisma æ¶æ„å˜æ›´
ç”±äºä¿®æ”¹äº†å·¥ä½ ID çš„ç±»å‹ï¼ˆä» `Int` åˆ° `String`ï¼‰ï¼Œéœ€è¦ä»å®¹å™¨å†…å‘æ•°æ®åº“åŒæ­¥ Schemaã€‚åŠ¡å¿…ç¡®ä¿å®¹å™¨å·²å¯åŠ¨å¹¶èƒ½è¿æ¥åˆ° DBã€‚

```bash
# ä½¿ç”¨ Docker Compose åœ¨åº”ç”¨å®¹å™¨å†…æ‰§è¡Œ
docker compose exec app npx prisma migrate deploy
```

### 4. æ‰§è¡Œæ•°æ®è¿ç§»è„šæœ¬
è¿™æ˜¯é’ˆå¯¹æ‚¨æåˆ°çš„â€œå·¥ä½ ID ä¿®æ”¹â€åçš„å…³é”®æ­¥éª¤ã€‚åŒæ ·å»ºè®®åœ¨å®¹å™¨å†…æ‰§è¡Œï¼Œä»¥ç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§ã€‚

```bash
# åœ¨åº”ç”¨å®¹å™¨å†…è¿è¡Œè¿ç§»è„šæœ¬
docker compose exec app node scripts/[æ‚¨çš„è¿ç§»è„šæœ¬åç§°].js
```
> [!NOTE]
> è¯·ç¡®ä¿è„šæœ¬ä¸­çš„ `DATABASE_URL` æ­£ç¡®æŒ‡å‘ç”Ÿäº§æ•°æ®åº“ã€‚

### 5. é‡å¯åº”ç”¨æœåŠ¡
æ›´æ–°å®¹å™¨æˆ–é‡å¯ Node.js è¿›ç¨‹ã€‚

**ä½¿ç”¨ Docker Compose:**
```bash
docker compose up --build -d
```

**ä½¿ç”¨ PM2:**
```bash
npm install
npm run build
pm2 restart all
```

---

## ğŸ” éƒ¨ç½²åéªŒè¯æ¸…å•

1.  **å·¥ä½ç»‘å®šéªŒè¯**ï¼šè¿›å…¥æ¸¸æˆï¼Œå°è¯•ç»‘å®šä¸€ä¸ªæ–°å·¥ä½ï¼Œæ£€æŸ¥ `user_workstations` è¡¨ä¸­çš„ `workstationId` æ˜¯å¦ä¸º UUID æ ¼å¼ã€‚
2.  **å­˜é‡æ•°æ®éªŒè¯**ï¼šæ£€æŸ¥è€ç”¨æˆ·æ˜¯å¦ä¾ç„¶èƒ½æ­£ç¡®å…³è”åˆ°è‡ªå·±çš„å·¥ä½ã€‚
3.  **æ—¥å¿—æ£€æŸ¥**ï¼šæŸ¥çœ‹ API æ—¥å¿—æ˜¯å¦æœ‰å…³äº `workstation` çš„ç±»å‹é”™è¯¯ã€‚
    ```bash
    tail -f logs/error.log  # æˆ–ä½¿ç”¨ docker logs
    ```
4.  **åœ°å›¾åŠ è½½éªŒè¯**ï¼šæ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼Œæ£€æŸ¥ `officemap.json` åŠ è½½æ˜¯å¦æ­£å¸¸ï¼Œå¯¹è±¡å±æ€§ä¸­æ˜¯å¦åŒ…å« `ws_id`ã€‚

---

## ğŸš¨ å¸¸è§é—®é¢˜æ±‡æ€»

*   **Q: è¿ç§»è„šæœ¬æ‰§è¡Œè¶…æ—¶æ€ä¹ˆåŠï¼Ÿ**
    *   A: å¯¹å¤§æ‰¹é‡æ•°æ®ä½¿ç”¨ Prisma äº‹åŠ¡æ—¶éœ€æ³¨æ„è¶…æ—¶è®¾ç½®ï¼Œå¿…è¦æ—¶åˆ†æ‰¹æ¬¡æ‰§è¡Œã€‚
*   **Q: Prisma æŠ¥é”™ ID ç±»å‹ä¸å…¼å®¹ï¼Ÿ**
    *   A: å¦‚æœ `Int` è½¬ `String` åœ¨æ•°æ®åº“å±‚é¢å—é˜»ï¼Œå¯èƒ½éœ€è¦å…ˆé€šè¿‡ SQL æ‰‹åŠ¨ `ALTER TABLE ... TYPE text`ã€‚
*   **Q: `migrate deploy` æç¤º "No migration found"ï¼Ÿ**
    *   A: `migrate deploy` ä»…åº”ç”¨ `prisma/migrations` æ–‡ä»¶å¤¹ä¸‹çš„**è¿ç§»æ–‡ä»¶å¤¹**ã€‚å¦‚æœæ‚¨åœ¨æœ¬åœ°ä½¿ç”¨çš„æ˜¯ `db push` è€Œæ²¡æœ‰ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼Œæˆ–è€…æ²¡æœ‰å°†è¿ç§»æ–‡ä»¶å¤¹ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå°±ä¼šæç¤ºæ­¤ä¿¡æ¯ã€‚
    *   **è§£å†³æ–¹æ¡ˆ A (æ¨è)**ï¼šåœ¨æœ¬åœ°è¿è¡Œ `npx prisma migrate dev --name change_workstation_id` ç”Ÿæˆè¿ç§»ï¼Œç„¶åæäº¤å¹¶æ¨é€ä»£ç ã€‚
    *   **è§£å†³æ–¹æ¡ˆ B (å¿«é€ŸåŒæ­¥)**ï¼šåœ¨æœåŠ¡å™¨è¿è¡Œ `docker compose exec app npx prisma db push`ã€‚æ³¨æ„ï¼šè¿™ä¼šç›´æ¥å¼ºåˆ¶æ•°æ®åº“åŒ¹é… Schemaï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½ã€‚
*   **Q: Docker Build æŠ¥é”™ `permission denied` è®¿é—® `data/postgres`ï¼Ÿ**
    *   A: è¿™æ˜¯å› ä¸º Docker å°è¯•å°†æ•°æ®åº“æ•°æ®ç›®å½•åŒ…å«åœ¨æ„å»ºä¸Šä¸‹æ–‡ä¸­ã€‚è¯·ç¡®ä¿æ ¹ç›®å½•å­˜åœ¨ `.dockerignore` æ–‡ä»¶å¹¶åŒ…å« `data` ç›®å½•ã€‚æˆ‘å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†è¯¥æ–‡ä»¶ã€‚
*   **Q: Prisma æŠ¥é”™ `EACCES: permission denied` æˆ– `unlink ... node_modules`ï¼Ÿ**
    *   A: è¿™æ˜¯å› ä¸ºå®¹å™¨å†… `node_modules` çš„æ‰€æœ‰è€…ä¸º rootã€‚æˆ‘å·²ç»æ›´æ–°äº† `Dockerfile`ï¼Œè¯·é‡æ–°æ„å»ºé•œåƒï¼š`docker compose up --build -d`ã€‚

---

> [!WARNING]
> **é‡è¦å‘ç°**ï¼šç›®å‰çš„ `prisma/schema.prisma` ä¸­ `workstations.id` ä»ä¸º `Int` ç±»å‹ï¼Œè€Œ `user_workstations.workstationId` ä¸º `String`ã€‚å¦‚æœæ‚¨åœ¨æ­¤å‰çš„è„šæœ¬è¿ç§»ä¸­å·²ç»å°†å·¥ä½ ID æ”¹ä¸ºäº† UUID (String)ï¼Œè¯·åŠ¡å¿…ç¡®è®¤ `schema.prisma` æ˜¯å¦å·²åŒæ­¥ä¿®æ”¹ä¸º `id String @id`ã€‚

---

**ç»´æŠ¤äººå‘˜**ï¼šAntigravity Assistant
**æ—¥æœŸ**ï¼š2026-01-18
